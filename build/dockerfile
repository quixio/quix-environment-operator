# Build stage
FROM golang:1.24.2 AS builder

WORKDIR /workspace

COPY go.mod ./
COPY hack/ ./hack/
COPY Makefile ./

RUN make setup-dev

# Copy the rest of the code
COPY cmd/ ./cmd/
COPY internal/ ./internal/
COPY api/ ./api/
COPY config/ ./config/
COPY LICENSE ./LICENSE

# Download dependencies and generate go.sum
RUN go mod download
RUN go mod tidy

# Build
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 make build

# Runtime stage (minimal container)
FROM gcr.io/distroless/static:nonroot
WORKDIR /
COPY --from=builder /workspace/bin/operator .
USER nonroot:nonroot

ENTRYPOINT ["/bin/operator"] 